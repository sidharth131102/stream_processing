# ------------------------------------------------------------------------------
# TRANSFORMATION CONFIGURATION
# ------------------------------------------------------------------------------
# This file defines HOW the incoming event payload is transformed.
# It controls:
# - Field flattening (moving fields from payload → top level)
# - Business rule derivations
# - Data enrichment (adding new fields)
# - Entity extraction from text fields
#
# IMPORTANT:
# - This file ONLY affects transformations
# - No infrastructure changes happen here
# - Safe to modify for client-specific logic
# ------------------------------------------------------------------------------

field_mapping:
  # --------------------------------------------------------------------------
  # FIELD FLATTENING & RENAMING
  # --------------------------------------------------------------------------
  # Purpose:
  # Incoming events usually have a nested structure like:
  # {
  #   "payload": {
  #     "request_id": "...",
  #     "customer_id": "...",
  #     ...
  #   }
  # }
  #
  # These mappings FLATTEN fields from "payload.*"
  # and bring them to the top-level record.
  #
  # Format:
  #   <target_field>: <source_path>
  #
  # You can:
  # - Rename fields
  # - Drop fields by removing mappings
  # - Add new mappings as needed
  # --------------------------------------------------------------------------

  #event_time: event_timestamp  
  # (Optional) Example of mapping an event timestamp field
  # Uncomment only if your payload has event_timestamp

  request_id: payload.request_id        # Unique identifier for the request
  customer_id: payload.customer_id      # Customer identifier
  request_type: payload.request_type    # Type/category of request
  priority: payload.priority            # Business priority (e.g., HIGH, LOW)
  location: payload.location            # Physical or logical location
  description: payload.description      # Free-text description
  source_system: payload.source_system  # Originating system name
  age: payload.age                      # Age of the request in days
  temperature_c: payload.temperature_c  # Temperature in Celsius (example of numeric field)
# ------------------------------------------------------------------------------
# NULL DEFAULTS
# ------------------------------------------------------------------------------
# Purpose:
# Replace null/empty field values with defaults.
#
# Supports either:
# 1) list style:
# null_defaults:
#   - field: priority
#     default: UNKNOWN
#   - field: age
#     default: 0
#
# 2) map style:
# null_defaults:
#   priority: UNKNOWN
#   age: 0
# ------------------------------------------------------------------------------
null_defaults:
  - field: age
    default: 0

# ------------------------------------------------------------------------------
# CONCATENATIONS
# ------------------------------------------------------------------------------
# Purpose:
# Build derived fields by concatenating one or more input fields.
#
# Example:
# concatenations:
#   - output_field: request_customer_key
#     inputs: [request_id, customer_id]
#     separator: "-"
#     skip_nulls: true
#     default_value: UNKNOWN
#     defaults:
#       customer_id: NA
#     type: STRING
# ------------------------------------------------------------------------------
concatenations: []

# ------------------------------------------------------------------------------
# BUSINESS RULES
# ------------------------------------------------------------------------------
# Purpose:
# Business rules allow you to DERIVE new fields based on conditions.
#
# Rules are evaluated AFTER field mapping.
#
# Format:
# - condition: Python-like expression
# - output_field: Name of new field to create
# - value: Value assigned when condition is true
#
# You can:
# - Add multiple rules
# - Create flags, scores, or categories
# ------------------------------------------------------------------------------

business_rules:
  - condition: "event.get('priority') == 'HIGH'"
    # If priority is HIGH, mark this request as critical

    output_field: is_critical
    # New field added to the record

    value: true
    # Value assigned when condition evaluates to true
  - condition: "event.get('request_type') == 'TEMPERATURE_ALERT'"
    # If request type is refund, assign a risk score

    output_field: urgency
    # New field for urgency assessment

    value: true
    # Example urgency flag for temperature alerts
# ------------------------------------------------------------------------------
# ENRICHMENT
# ------------------------------------------------------------------------------
# Purpose:
# Enrichment adds NEW information that does not exist in the event.
# Typically used for:
# - Region mapping
# - Category classification
# - Business group assignment
#
# Enrichment runs AFTER field mapping and business rules.
# ------------------------------------------------------------------------------

enrichment:
  - type: static_lookup
    # static_lookup means a fixed key-value mapping defined in YAML

    input_field: "location"
    # This field MUST already exist (comes from field_mapping)

    lookup:
      # Mapping of input values → enriched values
      Bangalore: SOUTH
      Mumbai: WEST
      Delhi: NORTH
      Assam: EAST

    output_field: region
    # New field created based on lookup result
  - type: range_lookup
    input_field: "temperature_c"
    output_field: "temperature_category"
    output_type: STRING
    default: "unknown"
    ranges:
      - min: -50
        max: 0
        value: "freezing"
      - min: 1
        max: 15
        value: "cold"
      - min: 16
        max: 25
        value: "mild"
      - min: 26
        max: 35
        value: "warm"
      - min: 36
        max: 50
        value: "hot"
  # - type: range_lookup
  #   input_field: "event_age_days"
  #   output_field: "age_bucket"
  #   output_type: STRING
  #   default: UNKNOWN
  #   ranges:
  #     - min: 0
  #       max: 7
  #       value: NEW
  #     - min: 8
  #       max: 30
  #       value: ACTIVE
  #     - min: 31
  #       value: STALE

  # - type: multi_key_lookup
  #   input_fields: ["location", "priority"]
  #   separator: "|"
  #   normalize_case: true
  #   output_field: "routing_queue"
  #   output_type: STRING
  #   default: "general_queue"
  #   lookup:
  #     "mumbai|high": "west_critical"
  #     "delhi|high": "north_critical"

  # - type: regex_lookup
  #   input_field: "description"
  #   output_field: "issue_category"
  #   output_type: STRING
  #   default: "unknown_issue"
  #   first_match: true
  #   patterns:
  #     - pattern: "(cable|wire)"
  #       value: "cable_issue"
  #       ignore_case: true
  #     - pattern: "(transformer)"
  #       value: "transformer_issue"
  #       ignore_case: true

  # - type: conditional_set
  #   output_field: "dispatch_tier"
  #   output_type: STRING
  #   default: "TIER_3"
  #   conditions:
  #     - when: "event.get('priority') == 'HIGH' and event.get('region') == 'WEST'"
  #       value: "TIER_1"
  #     - when: "event.get('priority') == 'HIGH'"
  #       value: "TIER_2"

  # - type: derived_fields
  #   fields:
  #     - output_field: "description_len"
  #       expression: "len(event.get('description') or '')"
  #       type: INT64
  #       default: 0
  #     - output_field: "priority_rank"
  #       expression: "3 if event.get('priority') == 'HIGH' else (2 if event.get('priority') == 'MEDIUM' else 1)"
  #       type: INT64
  #       default: 1

  # - type: normalization_enrichment
  #   input_field: "location"
  #   output_field: "location_normalized"
  #   output_type: STRING
  #   default: "unknown"
  #   operations: ["trim", "lower", "collapse_spaces"]
  #   synonyms:
  #     "bombay": "mumbai"
  #     "n delhi": "delhi"

# ------------------------------------------------------------------------------
# ENTITY EXTRACTION
# ------------------------------------------------------------------------------
# Purpose:
# Extracts structured information from unstructured text fields
# using regular expressions.
#
# Common use cases:
# - Detect equipment names
# - Extract keywords
# - Identify error types from descriptions
#
# Runs AFTER enrichment.
# ------------------------------------------------------------------------------

entity_extraction:
  - field: "description"
    # Text field from which entities are extracted
    # Must already exist (flattened earlier)

    entities:
      - name: equipment
        # Name of the extracted entity field

        pattern: "(transformer|meter|cable)"
        # Regex pattern used to identify keywords
        # Case-insensitive matching handled in code

# ------------------------------------------------------------------------------
# NOTE
# ------------------------------------------------------------------------------
# This file is EXPECTED to change between clients and use cases.
#
# Safe modifications:
# - Add/remove field mappings
# - Change business rules
# - Add new enrichment logic
# - Modify regex patterns
#
# Unsafe modifications:
# ❌ Do NOT change structure keys (field_mapping, enrichment, etc.)
# ❌ Do NOT rename root sections unless code is updated
# ------------------------------------------------------------------------------
